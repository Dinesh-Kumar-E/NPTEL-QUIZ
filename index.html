<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCI Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="/Resources/favicon.png" type="image/x-icon">
    <style>
        body {
            background: linear-gradient(178.1deg, rgb(60, 55, 106) 8.5%, rgb(23, 20, 69) 82.4%);
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.125);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .question-info {
            position: relative;
            display: inline-block;
        }

        .info-tooltip {
            display: none;
            position: absolute;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        .question-info:hover .info-tooltip {
            display: block;
        }

        .option-box {
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
        }

        .option-box:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        .option-box.selected {
            background-color: rgba(0, 0, 139, 0.7);
            /* Dark blue background for selected options */
            border-color: #ffffff;
            color: white;
            /* Ensure text is visible */
        }

        .option-box.correct {
            background-color: rgba(40, 167, 69, 0.7);
            border-color: #28a745;
        }

        .option-box.incorrect {
            background-color: rgba(220, 53, 69, 0.7);
            border-color: #dc3545;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #proceed-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            transition: all 0.3s ease;
        }

        #proceed-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .result-image {
            max-width: 300px;
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="home-page" class="container mt-5">
        <h1 class="text-center mb-4 text-white">Welcome to the Quiz</h1>
        <div class="row">
            <div class="col-md-4">
                <div class="card glass-card">
                    <div class="card-header text-white">
                        <h3>2024
                            <div class="form-check float-end">
                                <input class="form-check-input" type="checkbox" id="selectAll2024"
                                    onchange="toggleAll(2024)">
                                <label class="form-check-label text-white" for="selectAll2024">Select All</label>
                            </div>
                        </h3>
                    </div>
                    <div class="card-body" id="weeks2024"></div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card glass-card">
                    <div class="card-header text-white">
                        <h3>2023
                            <div class="form-check float-end">
                                <input class="form-check-input" type="checkbox" id="selectAll2023"
                                    onchange="toggleAll(2023)">
                                <label class="form-check-label text-white" for="selectAll2023">Select All</label>
                            </div>
                        </h3>
                    </div>
                    <div class="card-body" id="weeks2023"></div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card glass-card">
                    <div class="card-header text-white">
                        <h3>Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="shuffleQuestions">
                            <label class="form-check-label text-white" for="shuffleQuestions">
                                Shuffle Questions
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="shuffleOptions">
                            <label class="form-check-label text-white" for="shuffleOptions">
                                Shuffle Options
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-4">
            <button class="btn btn-light btn-lg" onclick="beginQuiz()">Begin Quiz</button>
        </div>
    </div>

    <div id="question-page" class="container mt-5" style="display: none;">
        <div class="card glass-card">
            <div class="card-header text-white">
                <h2 id="question-text" class="text-white"></h2>
                <div class="question-info">
                    <button class="btn btn-sm btn-light">â“˜</button>
                    <div class="info-tooltip" id="question-info"></div>
                </div>
            </div>
            <div class="card-body">
                <div id="options-container"></div>
                <div id="result-message" class="text-center text-white mt-3"></div>
                <div class="mt-4 text-center">
                    <button id="proceed-btn" class="btn" onclick="handleProceed()">Proceed</button>
                </div>
            </div>
        </div>
    </div>

    <div id="score-page" class="container mt-5 text-center" style="display: none;">
        <h1 class="text-white">Congratulations!</h1>
        <h2 class="text-white">Your Score: <span id="final-score"></span></h2>
        <div id="result-image-container" class="mt-4 d-flex justify-content-center"></div>
    </div>

    <script>
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedOptions = new Set();
        let questionsData = null;
        let answerChecked = false;
        let allowMultipleSelections = false; // New flag for multiple selections

        // async function loadQuestions() {
        //     try {
        //         const response = await fetch('https://api.jsonbin.io/v3/b/67236e39acd3cb34a8a01468', {
        //             method: 'GET',
        //             headers: {
        //                 'X-Master-Key': '$2a$10$aYeRTvUdfxdHU9D369vN7OKw2IwG9adAsflsG.4SiByO6nIqAsTjK'
        //             }
        //         });

        //         if (!response.ok) {
        //             throw new Error('Failed to load questions');
        //         }

        //         const data = await response.json();
        //         questionsData = data.record;
        //         document.getElementById('loading').style.display = 'none';
        //         initializeWeeks();
        //     } catch (error) {
        //         console.error('Error loading questions:', error);
        //         alert('Failed to load questions. Please try again.');
        //     }
        // }
        async function loadQuestions() {
            try {
                const response = await fetch('/resources/data.json');  // Update the path to your local JSON file

                if (!response.ok) {
                    throw new Error('Failed to load questions');
                }

                const data = await response.json();
                questionsData = data;
                document.getElementById('loading').style.display = 'none';
                initializeWeeks();
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Failed to load questions. Please try again.');
            }
        }


        function initializeWeeks() {
            const weeks2024 = document.getElementById('weeks2024');
            const weeks2023 = document.getElementById('weeks2023');

            for (let i = 1; i <= 12; i++) {
                weeks2024.innerHTML += `
            <div class="form-check">
                <input class="form-check-input week-2024" type="checkbox" id="week2024-${i}" value="${i}">
                <label class="form-check-label text-white" for="week2024-${i}">Week ${i}</label>
            </div>
        `;

                weeks2023.innerHTML += `
            <div class="form-check">
                <input class="form-check-input week-2023" type="checkbox" id="week2023-${i}" value="${i}">
                <label class="form-check-label text-white" for="week2023-${i}">Week ${i}</label>
            </div>
        `;
            }
        }

        function toggleAll(year) {
            const checkboxes = document.getElementsByClassName(`week-${year}`);
            const selectAllCheckbox = document.getElementById(`selectAll${year}`);
            for (let checkbox of checkboxes) {
                checkbox.checked = selectAllCheckbox.checked;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function beginQuiz() {
            const selectedWeeks = {
                2024: [],
                2023: []
            };

            document.querySelectorAll('.week-2024:checked').forEach(checkbox => {
                selectedWeeks[2024].push(parseInt(checkbox.value));
            });

            document.querySelectorAll('.week-2023:checked').forEach(checkbox => {
                selectedWeeks[2023].push(parseInt(checkbox.value));
            });

            questions = questionsData.questions.filter(q =>
                selectedWeeks[q.year].includes(q.week)
            );

            if (questions.length === 0) {
                alert('Please select at least one week');
                return;
            }

            if (document.getElementById('shuffleQuestions').checked) {
                questions = shuffleArray([...questions]);
            }

            // Check if multiple selections are allowed based on question type
            allowMultipleSelections = document.getElementById('allowMultipleSelections')
                ? document.getElementById('allowMultipleSelections').checked
                : false;

            currentQuestionIndex = 0;
            score = 0;
            answerChecked = false;

            document.getElementById('home-page').style.display = 'none';
            document.getElementById('question-page').style.display = 'block';

            displayQuestion();
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];

            // Check if multiple selections are allowed based on multiple correct answers
            const correctAnswers = Object.values(question.options).filter(isCorrect => isCorrect);
            allowMultipleSelections = correctAnswers.length > 1;

            document.getElementById('question-text').textContent = question.question;
            document.getElementById('question-info').textContent = `Year: ${question.year}, Week: ${question.week}`;
            document.getElementById('result-message').textContent = '';

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            let options = Object.entries(question.options);
            if (document.getElementById('shuffleOptions').checked) {
                options = shuffleArray([...options]);
            }

            // Clear previous selections and state
            selectedOptions.clear();
            answerChecked = false;

            options.forEach(([text, isCorrect], index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-box';
                optionDiv.onclick = () => toggleOption(index);
                optionDiv.textContent = text;
                optionDiv.dataset.index = index;
                optionDiv.dataset.correct = isCorrect;
                optionsContainer.appendChild(optionDiv);
            });

            document.getElementById('proceed-btn').textContent = 'Check Answer';
        }


        function toggleOption(index) {
            if (answerChecked) return;

            const optionDiv = document.querySelector(`[data-index="${index}"]`);

            // Handle multiple or single selection based on flag
            if (!allowMultipleSelections) {
                // Clear previous selections
                document.querySelectorAll('.option-box').forEach(el => {
                    el.classList.remove('selected');
                });
                selectedOptions.clear();
            }

            // Toggle current option
            if (selectedOptions.has(index)) {
                selectedOptions.delete(index);
                optionDiv.classList.remove('selected');
            } else {
                selectedOptions.add(index);
                optionDiv.classList.add('selected'); // Dark blue background for selected
            }
        }

        function handleProceed() {
            if (!answerChecked) {
                checkAnswer();
            } else {
                // Move to the next question
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    displayQuestion();
                } else {
                    showScore();
                }
            }
        }

        // Function to check the answer and display result
        function checkAnswer() {
            const question = questions[currentQuestionIndex];
            const options = Object.entries(question.options);
            const resultMessage = document.getElementById('result-message');
            const proceedBtn = document.getElementById('proceed-btn');

            if (selectedOptions.size === 0) {
                alert("Please select an option");
                return;
            }

            let isCorrect = true;
            let correctOptions = [];

            // Find correct options and mark them
            options.forEach(([text, isCorrectOption], index) => {
                const optionDiv = document.querySelector(`[data-index="${index}"]`);

                if (isCorrectOption) {
                    correctOptions.push(index);
                    optionDiv.classList.add('correct'); // Highlight all correct options

                    // Check if a correct option was missed
                    if (!selectedOptions.has(index)) {
                        isCorrect = false;
                    }
                }

                // Highlight all selected options
                if (selectedOptions.has(index)) {
                    if (!isCorrectOption) {
                        optionDiv.classList.add('incorrect'); // Mark incorrect selections
                        isCorrect = false;
                    }
                }
            });

            answerChecked = true;

            // Display result message
            if (isCorrect) {
                score++;
                resultMessage.textContent = 'Correct! Click Proceed to the next question.';
                resultMessage.style.color = 'lightgreen';
            } else {
                resultMessage.textContent = `Incorrect. Correct option(s): ${correctOptions.map(index =>
                    document.querySelector(`[data-index="${index}"]`).textContent
                ).join(', ')}`;
                resultMessage.style.color = 'red';
            }

            // Change button text to Proceed
            proceedBtn.textContent = 'Proceed';
        }

        // Function to display the final score
        function showScore() {
            document.getElementById('question-page').style.display = 'none';
            document.getElementById('score-page').style.display = 'block';

            const finalScoreSpan = document.getElementById('final-score');
            const scorePercentage = (score / questions.length) * 100;
            finalScoreSpan.textContent = `${score}/${questions.length} (${scorePercentage.toFixed(2)}%)`;

            const resultImageContainer = document.getElementById('result-image-container');
            resultImageContainer.innerHTML = '';
            // add image based on score
            if (scorePercentage >= 75) {
                resultImageContainer.innerHTML = '<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTp15JDVu04HkJZSAb6ZBeGkSDxWVZmLW5qGQ&s" class="result-image" alt="Perfect Score">';
            } else {
                resultImageContainer.innerHTML = '<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRI2oTI3tSnhm2rAfFvm3shPofpaYIU20m2Sg&s" class="result-image" alt="Poor Score">';
            }
        }

        window.onload = () => {
            loadQuestions();
        };
    </script>
</body>

</html>